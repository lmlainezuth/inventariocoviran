<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Inventario - Esc√°ner de C√≥digos</title>
        <script
            src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
        <style>
        /* Modal para crear categor√≠a/marca */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    background: none;
    color: #6b7280;
    text-decoration: none;  /* A√±ade esta l√≠nea */
}

.modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #1f2937;
}

.modal-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
}

.modal-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
}

.modal-btn-cancel {
    background: #6b7280;
    color: white;
}

.modal-btn-save {
    background: #2563eb;
    color: white;
}
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .scanner-section {
            padding: 20px;
        }
        
        #reader {
            border: 2px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            min-height: 300px;
        }
        
        #reader canvas,
        #reader video {
            width: 100% !important;
            height: auto !important;
        }
        
        #reader canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #64748b;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        .result {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result-code {
            font-size: 18px;
            font-weight: bold;
            color: #166534;
            margin-bottom: 10px;
        }
        
        .product-form {
            display: none;
        }
        
        .product-form.show {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .photo-upload {
            margin-bottom: 10px;
        }
        
        .photo-buttons {
            display: flex;
            gap: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }
        
        select {
            background: white;
            cursor: pointer;
        }
        
        .inventory-list {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .inventory-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1f2937;
        }
        
        .inventory-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .item-code {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }
        
        .item-quantity {
            background: #2563eb;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .btn-delete:hover {
            background: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            color: #6b7280;
        }
        
        .nav-item.active {
            color: #2563eb;
        }
        
        .nav-item:hover {
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .nav-icon {
            font-size: 24px;
        }
        
        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Page sections */
        .page-section {
            display: none;
            padding-bottom: 80px;
        }
        
        .page-section.active {
            display: block;
        }
        
        body {
            padding-bottom: 80px;
        }
        .dropdown {
    position: absolute;
    top: 20px;
    right: 20px;
}

.settings-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.3s;
}

.settings-btn:hover {
    background: rgba(255,255,255,0.3);
}

.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    top: 50px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    min-width: 200px;
    z-index: 1000;
}

.dropdown-content.show {
    display: block;
}

.dropdown-item {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: #2c3e50;
    transition: background 0.2s;
}

.dropdown-item:first-child {
    border-radius: 8px 8px 0 0;
}

.dropdown-item:last-child {
    border-radius: 0 0 8px 8px;
}

.dropdown-item:hover {
    background: #f3f4f6;
}

.dropdown-item span:first-child {
    font-size: 18px;
}
    </style>

       <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    </head>
    <body>
        <div class="container">
            <header style="position: relative;">
    <h1>üì¶ Escaner</h1>
    <div class="dropdown">
        <button class="settings-btn" onclick="toggleDropdown()">‚öôÔ∏è</button>
        <div id="dropdownMenu" class="dropdown-content">
            <button class="dropdown-item" onclick="window.location.href='admin.html'">
                <span>üëë</span>
                <span>Administraci√≥n</span>
            </button>
            <button class="dropdown-item" onclick="logout()">
                <span>üö™</span>
                <span>Cerrar sesi√≥n</span>
            </button>
        </div>
    </div>
</header>

            <!-- P√°gina Escanear -->
            <div id="scanPage" class="page-section active">
                <div class="scanner-section">
                    
                    <div id="scannerContainer">
                        <div id="reader"></div>

                        <div id="scanStatus"
                            style="text-align: center; padding: 10px; margin: 10px 0; background: #f3f4f6; border-radius: 8px; display: none;">
                            <div
                                style="font-size: 14px; color: #6b7280;">Escaneando...</div>
                            <div id="detectionProgress"
                                style="font-size: 12px; color: #9ca3af; margin-top: 5px;"></div>
                        </div>
                    </div>

                    <div id="result" class="result">
                        <div class="result-code">C√≥digo escaneado: <span
                                id="scannedCode"></span></div>
                    </div>

                    <div id="productForm" class="product-form">
                        <!-- Foto del Producto -->
                        <div class="form-group">
                            <label>Foto del Producto</label>
                            <div class="photo-upload">
                                <img id="productPhoto" src alt="Vista previa"
                                    style="display: none; width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                                <div class="photo-buttons">
                                    <button type="button"
                                        onclick="document.getElementById('cameraInput').click()"
                                        class="btn-secondary" style="flex: 1;">
                                        üì∑ C√°mara
                                    </button>
                                    <button type="button"
                                        onclick="document.getElementById('galleryInput').click()"
                                        class="btn-secondary" style="flex: 1;">
                                        üñºÔ∏è Galer√≠a
                                    </button>
                                </div>
                                <input type="file" id="cameraInput"
                                    accept="image/*" capture="environment"
                                    style="display: none;"
                                    onchange="handlePhotoUpload(event)">
                                <input type="file" id="galleryInput"
                                    accept="image/*" style="display: none;"
                                    onchange="handlePhotoUpload(event)">
                            </div>
                        </div>

                        <!-- Nombre del producto -->
                        <div class="form-group">
                            <label>Nombre del producto *</label>
                            <input type="text" id="productName"
                                placeholder="Ej: Leche Entera" required>
                        </div>

                        <!-- Cantidad y Unidad -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Cantidad *</label>
                                <input type="number" id="productQuantity"
                                    value="1" min="0" step="0.01">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Unidad</label>
                                <select id="productUnit">
                                    <option value="unidad">Unidad</option>
                                    <option value="kilogramo">Kilogramo
                                        (kg)</option>
                                    <option value="gramo">Gramo (g)</option>
                                    <option value="litro">Litro (L)</option>
                                    <option value="mililitro">Mililitro
                                        (ml)</option>
                                    <option value="centilitro">Centilitro
                                        (cl)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Min y Max Cantidad -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Cantidad M√≠nima</label>
                                <input type="number" id="minQuantity" value="0"
                                    min="0" step="0.01">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Cantidad M√°xima</label>
                                <input type="number" id="maxQuantity" value
                                    min="0" step="0.01" placeholder="Opcional">
                            </div>
                        </div>

                        <!-- Precios -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Precio Compra (‚Ç¨)</label>
                                <input type="number" id="purchasePrice" value
                                    min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Precio P√∫blico (‚Ç¨)</label>
                                <input type="number" id="publicPrice" value
                                    min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Categor√≠a y Marca -->
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label>Categor√≠a</label>
                                <select id="category">
                                    <option value>Cargando...</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Marca</label>
                                <select id="brand">
                                    <option value>Cargando...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tienda (selector) -->
<div class="form-group">
    <label>Tienda</label>
    <select id="storeSelector" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; background: white; cursor: pointer;">
        <option value="">Cargando...</option>
    </select>
</div>

                        <button onclick="saveProduct()" class="btn-primary"
                            style="width: 100%;">üíæ Guardar Producto</button>
                    </div>
                </div>
            </div>

            <!-- P√°gina Admin -->
            <!--<div id="adminPage" class="page-section">
                <div class="scanner-section">
                    <h2 style="margin-bottom: 20px;">Administraci√≥n</h2>

                    <div class="form-group">
                        <button onclick="exportInventory()" class="btn-primary"
                            style="width: 100%; margin-bottom: 10px;">
                            üì• Exportar Inventario (CSV)
                        </button>
                    </div>

                    <div class="form-group">
                        <button onclick="clearInventory()" class="btn-secondary"
                            style="width: 100%; background: #ef4444;">
                            üóëÔ∏è Borrar Todo el Inventario
                        </button>
                    </div>

                    <div
                        style="margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                        <h3
                            style="font-size: 16px; margin-bottom: 10px;">Estad√≠sticas</h3>
                        <p style="color: #6b7280;">Total de productos: <strong
                                id="totalProducts">0</strong></p>
                        <p style="color: #6b7280;">Total de unidades: <strong
                                id="totalUnits">0</strong></p>
                    </div>
                </div>
            </div>-->
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-item">
                <div class="nav-icon">üí∞</div>
                <div class="nav-label">Cierre Caja</div>
            </a>
            <a href="inventario-lista.html" class="nav-item">
                <div class="nav-icon">üì¶</div>
                <div class="nav-label">Inventario</div>
            </a>
             <a href="pedidos.html" class="nav-item">
        <div class="nav-icon">üõí</div>
        <div class="nav-label">Pedidos</div>
    </a>
            <a href="monedas.html" class="nav-item active">
                <div class="nav-icon">üì±</div>
                <div class="nav-label">Escanear</div>
            </a>
        </div>

<script>
    // Verificar autenticaci√≥n
(function() {
    const isAuthenticated = localStorage.getItem('inventoryAuth');
    if (isAuthenticated !== 'true') {
        window.location.href = 'login.html';
    }
})();
// Variables globales
let supabaseClient;
let isScanning = false;
let currentCode = null;
let inventory = [];
let lastDetectedCode = null;
let detectionTimeout = null;
let detectionCounter = {};
let currentPhotoBase64 = null;
const DETECTION_THRESHOLD = 5;
let scanTimeout = null;



// Inicializar cuando la p√°gina est√© lista
window.addEventListener('DOMContentLoaded', function() {
    // Configuraci√≥n de Supabase
    const supabaseUrl = 'https://ajrdwhxudwyyxmljnchc.supabase.co';
    const supabaseKey = 'sb_publishable_zknVqQ0PUPCLLiEP-p5iqg_9bsB5ZxS';
    
   supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

// Gesti√≥n de tiendas
let currentStore = localStorage.getItem('currentStore') || 'IZTIETA';

async function loadStores() {
    try {
        const { data: stores, error } = await supabaseClient.from('stores').select('*').order('name');
        if (error) throw error;
        
        const selector = document.getElementById('storeSelector');
        selector.innerHTML = stores.map(store => 
            `<option value="${store.code}" ${store.code === currentStore ? 'selected' : ''}>${store.name}</option>`
        ).join('');
    } catch (error) {
        console.error('Error cargando tiendas:', error);
    }
}

// Verificar si viene un c√≥digo en la URL
const urlParams = new URLSearchParams(window.location.search);
const codeFromUrl = urlParams.get('code');



    
   Promise.all([loadInventory(), loadCategories(), loadBrands(), loadStores()]).then(() => {
      
        setupModalListeners();
        
        if (codeFromUrl) {
            currentCode = codeFromUrl;
            document.getElementById('scannedCode').textContent = codeFromUrl;
            document.getElementById('result').classList.add('show');
            document.getElementById('scannerContainer').style.display = 'none';
            loadProductData(codeFromUrl);
        } else {
            startScanner();
        }
    });
});

// Setup de listeners para modales
function setupModalListeners() {
    const categorySelect = document.getElementById('category');
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            if (this.value === '__CREATE__') {
                this.blur();
                setTimeout(() => {
                    openModal('category');
                    this.value = '';
                }, 50);
            }
        });
    }
    
    const brandSelect = document.getElementById('brand');
    if (brandSelect) {
        brandSelect.addEventListener('change', function() {
            if (this.value === '__CREATE__') {
                this.blur();
                setTimeout(() => {
                    openModal('brand');
                    this.value = '';
                }, 50);
            }
        });
    }
}
// Cargar categor√≠as
async function loadCategories() {
    try {
        const { data, error } = await supabaseClient
            .from('categories')
            .select('*')
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        const select = document.getElementById('category');
        select.innerHTML = '<option value="">Seleccionar...</option>';
        
        data.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            select.appendChild(option);
        });
        
        const createOption = document.createElement('option');
        createOption.value = '__CREATE__';
        createOption.textContent = '‚ûï Crear nueva categor√≠a...';
        createOption.style.color = '#2563eb';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
    } catch (error) {
        console.error('Error cargando categor√≠as:', error);
    }
}

// Cargar marcas
async function loadBrands() {
    try {
        const { data, error } = await supabaseClient
            .from('brands')
            .select('*')
            .order('name', { ascending: true });
        
        if (error) throw error;
        
        const select = document.getElementById('brand');
        select.innerHTML = '<option value="">Seleccionar...</option>';
        
        data.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.name;
            option.textContent = brand.name;
            select.appendChild(option);
        });
        
        const createOption = document.createElement('option');
        createOption.value = '__CREATE__';
        createOption.textContent = '‚ûï Crear nueva marca...';
        createOption.style.color = '#2563eb';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
    } catch (error) {
        console.error('Error cargando marcas:', error);
    }
}

// Funciones del modal
function openModal(type) {
    const modal = document.getElementById(type + 'Modal');
    modal.classList.add('show');
    setTimeout(() => {
        document.getElementById('new' + (type === 'category' ? 'Category' : 'Brand') + 'Input').focus();
    }, 100);
}

function closeModal(type) {
    const modal = document.getElementById(type + 'Modal');
    modal.classList.remove('show');
    document.getElementById('new' + (type === 'category' ? 'Category' : 'Brand') + 'Input').value = '';
}

async function saveNewCategory() {
    const name = document.getElementById('newCategoryInput').value.trim();
    if (!name) {
        alert('Por favor ingresa un nombre para la categor√≠a');
        return;
    }
    
    try {
        const { error } = await supabaseClient.from('categories').insert([{ name }]);
        if (error) {
            if (error.code === '23505') alert('Esta categor√≠a ya existe');
            else throw error;
            return;
        }
        
        alert('‚úÖ Categor√≠a creada');
        closeModal('category');
        await loadCategories();
        // Esperar un poco para que cargue
        setTimeout(() => {
            document.getElementById('category').value = name;
        }, 200);
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function saveNewBrand() {
    const name = document.getElementById('newBrandInput').value.trim();
    if (!name) {
        alert('Por favor ingresa un nombre para la marca');
        return;
    }
    
    try {
        const { error } = await supabaseClient.from('brands').insert([{ name }]);
        if (error) {
            if (error.code === '23505') alert('Esta marca ya existe');
            else throw error;
            return;
        }
        
        alert('‚úÖ Marca creada');
        closeModal('brand');
        await loadBrands();
        // Esperar un poco para que cargue
        setTimeout(() => {
            document.getElementById('brand').value = name;
        }, 200);
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
function switchPage(page) {
    document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    if (page === 'scan') {
        document.getElementById('scanPage').classList.add('active');
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        if (!isScanning) startScanner();
    } else if (page === 'monedas') {
    if (isScanning) stopScanner();
    document.getElementById('monedasPage').classList.add('active');
    document.querySelectorAll('.nav-item')[2].classList.add('active');
  
}
}

function startScanner() {
    isScanning = true;
    detectionCounter = {};
    document.getElementById('scanStatus').style.display = 'block';
    document.getElementById('detectionProgress').textContent = 'Apunta al c√≥digo de barras...';
    
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#reader'),
            constraints: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
        },
        decoder: {
            readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "upc_reader", "upc_e_reader"],
            debug: { drawBoundingBox: true, showFrequency: true, drawScanline: true, showPattern: true }
        },
        locate: true,
        locator: { halfSample: true, patchSize: "medium" },
        frequency: 10,
    }, function(err) {
        if (err) {
            console.error(err);
            alert('Error al iniciar c√°mara: ' + err);
            return;
        }
        Quagga.start();
    });
    
    Quagga.onDetected(onBarcodeDetected);
}

function stopScanner() {
    if (isScanning) {
        Quagga.stop();
        Quagga.offDetected(onBarcodeDetected);
        isScanning = false;
        document.getElementById('scanStatus').style.display = 'none';
    }
}

function onBarcodeDetected(result) {
    if (!isScanning) return;
    
    const code = result.codeResult.code;
    const errors = result.codeResult.decodedCodes.reduce((sum, code) => sum + (code.error || 0), 0);
    const errorRate = errors / result.codeResult.decodedCodes.length;
    
    if (errorRate > 0.15 || !code || code.length < 8 || !/^[A-Z0-9]+$/i.test(code)) return;
    
    detectionCounter[code] = (detectionCounter[code] || 0) + 1;
    document.getElementById('detectionProgress').textContent = `Detectando: ${code} (${detectionCounter[code]}/${DETECTION_THRESHOLD})`;
    
    for (let key in detectionCounter) {
        if (key !== code && detectionCounter[key] < DETECTION_THRESHOLD) delete detectionCounter[key];
    }
    
    if (detectionCounter[code] >= DETECTION_THRESHOLD) {
        lastDetectedCode = code;
        currentCode = code;
        detectionCounter = {};
        document.getElementById('scannedCode').textContent = code;
        document.getElementById('result').classList.add('show');
        playBeep();
        stopScanner();
        loadProductData(code);
        
        if (detectionTimeout) clearTimeout(detectionTimeout);
        detectionTimeout = setTimeout(() => { lastDetectedCode = null; }, 3000);
    }
}

function playBeep() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    gainNode.gain.value = 0.3;
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
}

async function loadProductData(code) {
    try {
        // Obtener datos del producto
        const { data: existingProduct, error } = await supabaseClient
            .from('products')
            .select('*')
            .eq('code', code)
            .maybeSingle();
        
        if (error) throw error;
        
        document.getElementById('scannerContainer').style.display = 'none';
        
        if (existingProduct) {
            // Obtener el stock de la tienda actual
            const selectedStore = document.getElementById('storeSelector').value;
            const { data: stockData } = await supabaseClient
                .from('product_stock')
                .select('*')
                .eq('product_code', code)
                .eq('store_code', selectedStore)
                .maybeSingle();
            
            // Cargar datos del producto
            document.getElementById('productName').value = existingProduct.name;
            document.getElementById('productUnit').value = existingProduct.unit || 'unidad';
            document.getElementById('category').value = existingProduct.category || '';
            document.getElementById('brand').value = existingProduct.brand || '';
            
            // Cargar datos del stock de la tienda
            if (stockData) {
                document.getElementById('productQuantity').value = stockData.quantity;
                document.getElementById('minQuantity').value = stockData.min_quantity || 0;
                document.getElementById('maxQuantity').value = stockData.max_quantity || '';
                document.getElementById('purchasePrice').value = stockData.purchase_price || '';
                document.getElementById('publicPrice').value = stockData.public_price || '';
            } else {
                // Si no hay stock en esta tienda, valores por defecto
                document.getElementById('productQuantity').value = 0;
                document.getElementById('minQuantity').value = 0;
                document.getElementById('maxQuantity').value = '';
                document.getElementById('purchasePrice').value = '';
                document.getElementById('publicPrice').value = '';
            }
            
            if (existingProduct.photo) {
                document.getElementById('productPhoto').src = existingProduct.photo;
                document.getElementById('productPhoto').style.display = 'block';
                currentPhotoBase64 = existingProduct.photo;
            }
            
            document.getElementById('result').innerHTML = `<div class="result-code">‚úÖ Producto encontrado</div>`;
        } else {
            document.getElementById('result').innerHTML = `<div class="result-code">üÜï Producto nuevo: <span id="scannedCode">${code}</span></div>`;
        }
        
        document.getElementById('productForm').classList.add('show');
        document.getElementById('productName').focus();
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('scannerContainer').style.display = 'none';
        document.getElementById('productForm').classList.add('show');
        document.getElementById('productName').focus();
    }
}
async function uploadImageToSupabase(file) {
    try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
        const filePath = `products/${fileName}`;
        
        const { data, error } = await supabaseClient.storage.from('product-images').upload(filePath, file);
        if (error) throw error;
        
        const { data: urlData } = supabaseClient.storage.from('product-images').getPublicUrl(filePath);
        return urlData.publicUrl;
    } catch (error) {
        alert('Error subiendo imagen: ' + error.message);
        return null;
    }
}

async function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const compressedFile = await compressImage(file, 400, 0.5);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('productPhoto').src = e.target.result;
        document.getElementById('productPhoto').style.display = 'block';
    };
    reader.readAsDataURL(compressedFile);
    
    const imageUrl = await uploadImageToSupabase(compressedFile);
    if (imageUrl) currentPhotoBase64 = imageUrl;
}

function compressImage(file, maxWidth, quality) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                }, 'image/jpeg', quality);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function saveProduct() {
    if (!currentCode || currentCode.length < 3) { // Cambi√© de 8 a 3 para permitir c√≥digos manuales
        alert('‚ùå ERROR: C√≥digo inv√°lido');
        clearProductForm();
        document.getElementById('scannerContainer').style.display = 'block';
        return;
    }
    
    const name = document.getElementById('productName').value.trim();
    if (!name) {
        alert('Por favor ingresa el nombre del producto');
        return;
    }
    
    const quantity = parseFloat(document.getElementById('productQuantity').value);
    const unit = document.getElementById('productUnit').value;
    const minQuantity = parseFloat(document.getElementById('minQuantity').value) || 0;
    const maxQuantity = parseFloat(document.getElementById('maxQuantity').value) || null;
    const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
    const publicPrice = parseFloat(document.getElementById('publicPrice').value) || 0;
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value;
  
    
    try {
        const { data: existingProduct } = await supabaseClient.from('products').select('*').eq('code', currentCode).maybeSingle();
        
        // Verificar si venimos desde la lista (URL tiene par√°metro 'code')
        const urlParams = new URLSearchParams(window.location.search);
        const fromList = urlParams.has('code');
        
        if (existingProduct) {
    const selectedStore = document.getElementById('storeSelector').value;
    
    if (confirm('Este c√≥digo ya existe.\n\n¬øActualizar todo (SI) o solo sumar cantidad (NO)?')) {
        // Actualizar info general del producto
        await supabaseClient.from('products').update({
            name, unit, category, brand, photo: currentPhotoBase64
        }).eq('code', currentCode);
        
        // Actualizar stock de la tienda
        await supabaseClient.from('product_stock').upsert({
            product_code: currentCode,
            store_code: selectedStore,
            quantity,
            min_quantity: minQuantity,
            max_quantity: maxQuantity,
            purchase_price: purchasePrice,
            public_price: publicPrice
        }, { onConflict: 'product_code,store_code' });
    } else {
        // Solo sumar cantidad
        const { data: currentStock } = await supabaseClient
            .from('product_stock')
            .select('quantity')
            .eq('product_code', currentCode)
            .eq('store_code', selectedStore)
            .single();
        
        await supabaseClient.from('product_stock').upsert({
            product_code: currentCode,
            store_code: selectedStore,
            quantity: (currentStock?.quantity || 0) + quantity,
            min_quantity: minQuantity,
            max_quantity: maxQuantity,
            purchase_price: purchasePrice,
            public_price: publicPrice
        }, { onConflict: 'product_code,store_code' });
    }
} else {
    const selectedStore = document.getElementById('storeSelector').value;
    
    // Crear producto
    await supabaseClient.from('products').insert([{
        code: currentCode,
        name,
        unit,
        category,
        brand,
        photo: currentPhotoBase64
    }]);
    
    // Crear stock para la tienda
    await supabaseClient.from('product_stock').insert([{
        product_code: currentCode,
        store_code: selectedStore,
        quantity,
        min_quantity: minQuantity,
        max_quantity: maxQuantity,
        purchase_price: purchasePrice,
        public_price: publicPrice
    }]);
}
        
        alert('‚úÖ Producto guardado');
        
        // Si venimos desde la lista, regresar a la lista
        if (fromList) {
            window.location.href = 'inventario-lista.html';
        } else {
            // Si no, continuar escaneando
            clearProductForm();
            startScanner();
            await loadInventory();
            updateStats();
            document.getElementById('scannerContainer').style.display = 'block';
            currentCode = null;
            currentPhotoBase64 = null;
        }
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
async function loadInventory() {
    try {
        const { data, error } = await supabaseClient.from('products').select('*').order('name', { ascending: true });
        if (error) throw error;
        inventory = data || [];
    } catch (error) {
        inventory = [];
    }
}

function clearProductForm() {
    document.getElementById('productName').value = '';
    document.getElementById('productQuantity').value = '1';
    document.getElementById('productUnit').value = 'unidad';
    document.getElementById('minQuantity').value = '0';
    document.getElementById('maxQuantity').value = '';
    document.getElementById('purchasePrice').value = '';
    document.getElementById('publicPrice').value = '';
    document.getElementById('category').value = '';
    document.getElementById('brand').value = '';
    document.getElementById('productPhoto').style.display = 'none';
    document.getElementById('productPhoto').src = '';
    document.getElementById('result').classList.remove('show');
    document.getElementById('productForm').classList.remove('show');
    document.getElementById('scannerContainer').style.display = 'block';
    }

async function updateStats() {
    await loadInventory();
    const totalProducts = inventory.length;
    const totalUnits = inventory.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('totalUnits').textContent = totalUnits.toFixed(2);
}

async function exportInventory() {
    await loadInventory();
    if (inventory.length === 0) {
        alert('No hay productos para exportar');
        return;
    }
    
    let csv = 'C√≥digo,Nombre,Cantidad,Unidad,Min,Max,Precio Compra,Precio Venta,Margen %,Categor√≠a,Marca,Ubicaci√≥n,Fecha\n';
    inventory.forEach(item => {
        const date = new Date(item.created_at).toLocaleDateString('es-ES');
        const margin = item.public_price > 0 && item.purchase_price > 0 
            ? ((item.public_price - item.purchase_price) / item.purchase_price * 100).toFixed(2) : '';
        csv += `${item.code},"${item.name}",${item.quantity},${item.unit || 'unidad'},${item.min_quantity || 0},${item.max_quantity || ''},${item.purchase_price || 0},${item.public_price || 0},${margin},"${item.category || ''}","${item.brand || ''}","${item.location || ''}",${date}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

async function clearInventory() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de borrar TODO el inventario?')) {
        if (confirm('Confirmaci√≥n final: ¬øRealmente quieres borrar todos los productos?')) {
            try {
                await supabaseClient.from('products').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                inventory = [];
              
                alert('Inventario borrado');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    }
}
// Toggle dropdown menu
function toggleDropdown() {
    document.getElementById('dropdownMenu').classList.toggle('show');
}

// Cerrar dropdown si se hace clic fuera
window.onclick = function(event) {
    if (!event.target.matches('.settings-btn')) {
        const dropdowns = document.getElementsByClassName('dropdown-content');
        for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}

// Funci√≥n de logout
function logout() {
    localStorage.removeItem('inventoryAuth');
    window.location.href = 'login.html';
}
</script>

<!-- Modal para crear categor√≠a -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Nueva Categor√≠a</div>
        <input type="text" id="newCategoryInput" class="modal-input" placeholder="Nombre de la categor√≠a">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeModal('category')">Cancelar</button>
            <button class="modal-btn modal-btn-save" onclick="saveNewCategory()">Guardar</button>
        </div>
    </div>
</div>

<!-- Modal para crear marca -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Nueva Marca</div>
        <input type="text" id="newBrandInput" class="modal-input" placeholder="Nombre de la marca">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeModal('brand')">Cancelar</button>
            <button class="modal-btn modal-btn-save" onclick="saveNewBrand()">Guardar</button>
        </div>
    </div>
</div>
    </body>
</html>