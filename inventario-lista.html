<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - COVIR√ÅN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #5a9fd4 0%, #4a8fc7 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        /* Search Bar */
        .search-container {
            padding: 15px 20px;
            background: linear-gradient(135deg, #5a9fd4 0%, #4a8fc7 100%);
        }
        
        .search-box {
            background: rgba(255,255,255,0.9);
            border-radius: 25px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-box input {
            flex: 1;
            border: none;
            background: none;
            font-size: 16px;
            outline: none;
            color: #374151;
        }
        
        .search-box input::placeholder {
            color: #9ca3af;
        }
        
        /* Filters */
        .filters {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 20px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #f3f4f6;
        }
        
        .filter-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* Dropdown Menu */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background-color: white;
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 1000;
    margin-top: 8px;
    overflow: hidden;
}

.dropdown-content.show {
    display: block;
}

.dropdown-item {
    color: #374151;
    padding: 12px 16px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 15px;
    transition: background 0.2s;
}

.dropdown-item:hover {
    background-color: #f3f4f6;
}

.dropdown-item:active {
    background-color: #e5e7eb;
}
        
        /* Product List */
        .product-list {
            padding: 0 10px;
        }
        
        .product-item {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .product-item:active {
            transform: scale(0.98);
            background: #f9fafb;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: #f3f4f6;
            flex-shrink: 0;
        }
        
        .product-info {
            flex: 1;
            min-width: 0;
        }
        
        .product-name {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-quantity {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .product-code {
            font-size: 12px;
            color: #9ca3af;
            font-family: monospace;
        }
        
        .product-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .badge-min {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-max {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-normal {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .badge-out {
            background: #fee2e2;
            color: #991b1b;
        }
                .arrow-icon {
            color: #d1d5db;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6b7280;
            text-decoration: none;
        }
        
        .nav-item.active {
            color: #2563eb;
        }
        
        .nav-icon {
            font-size: 24px;
        }
        
        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Modal para producto manual */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #1f2937;
}

.modal-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 20px;
}

.modal-buttons {
    display: flex;
    gap: 10px;
}

.modal-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
}

.modal-btn-cancel {
    background: #6b7280;
    color: white;
}

.modal-btn-save {
    background: #2563eb;
    color: white;
}
    </style>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
    <h1>üì¶ Inventario</h1>
    <select id="storeSelector" onchange="changeStore()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">
        <option value="">Cargando...</option>
    </select>
</div>
        <div class="dropdown">
    <button class="settings-btn" onclick="toggleDropdown()">‚öôÔ∏è</button>
    <div id="dropdownMenu" class="dropdown-content">
        <button class="dropdown-item" onclick="createManualProduct()">
            <span>‚ûï</span>
            <span>Crear producto manual</span>
        </button>
        <button class="dropdown-item" onclick="window.location.href='admin.html'">
            <span>üëë</span>
            <span>Administraci√≥n</span>
        </button>
        <button class="dropdown-item" onclick="logout()">
    <span>üö™</span>
    <span>Cerrar sesi√≥n</span>
</button>
    </div>
</div>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
        <div class="search-box">
            <span style="color: #9ca3af;">üîç</span>
            <input type="text" id="searchInput" placeholder="Buscar" onkeyup="filterProducts()">
        </div>
    </div>
    
<!-- Filters -->
<div class="filters">
    <button class="filter-btn" onclick="openFilterModal('order')">
        Ordenar <span id="orderIndicator">‚ñº</span>
    </button>
    <button class="filter-btn" onclick="openFilterModal('category')">
        Categor√≠a <span id="categoryIndicator">‚ñº</span>
    </button>
    <button class="filter-btn" onclick="openFilterModal('brand')">
        Marca <span id="brandIndicator">‚ñº</span>
    </button>
    <button class="filter-btn" onclick="openFilterModal('location')">
        Ubicaci√≥n <span id="locationIndicator">‚ñº</span>
    </button>
    <button class="filter-btn" onclick="openFilterModal('stock')">
        Cantidad <span id="stockIndicator">‚ñº</span>
    </button>
</div>
    
    <!-- Product List -->
    <div class="product-list" id="productList">
        <!-- Products will be loaded here -->
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="index.html" class="nav-item">
    <div class="nav-icon">üí∞</div>
    <div class="nav-label">Cierre Caja</div>
</a>
<a href="inventario-lista.html" class="nav-item active">
    <div class="nav-icon">üì¶</div>
    <div class="nav-label">Inventario</div>
</a>
 <a href="pedidos.html" class="nav-item">
        <div class="nav-icon">üõí</div>
        <div class="nav-label">Pedidos</div>
    </a>
<a href="monedas.html" class="nav-item">
    <div class="nav-icon">üì±</div>
    <div class="nav-label">Escanear</div>
</a>
    </div>

    <script>
        // Verificar autenticaci√≥n
(function() {
    const isAuthenticated = localStorage.getItem('inventoryAuth');
    if (isAuthenticated !== 'true') {
        window.location.href = 'login.html';
    }
})();

function logout() {
    if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
        localStorage.removeItem('inventoryAuth');
        window.location.href = 'login.html';
    }
}
        // Configurar Supabase
        const supabaseUrl = 'https://ajrdwhxudwyyxmljnchc.supabase.co';
        const supabaseKey = 'sb_publishable_zknVqQ0PUPCLLiEP-p5iqg_9bsB5ZxS';
          const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Gesti√≥n de tiendas
        let currentStore = localStorage.getItem('currentStore') || 'IZTIETA';

        async function loadStores() {
            try {
                const { data: stores, error } = await supabaseClient.from('stores').select('*').order('name');
                if (error) throw error;
                
                const selector = document.getElementById('storeSelector');
                selector.innerHTML = stores.map(store => 
                    `<option value="${store.code}" ${store.code === currentStore ? 'selected' : ''}>${store.name}</option>`
                ).join('');
            } catch (error) {
                console.error('Error cargando tiendas:', error);
            }
        }

        function changeStore() {
            currentStore = document.getElementById('storeSelector').value;
            localStorage.setItem('currentStore', currentStore);
            loadProducts();
        }

        // Inicializar tiendas
        loadStores();
        
        let inventory = [];
        let currentFilter = 'all';
       let currentSort = 'expiry_asc';
        let filters = {
    category: 'all',
    brand: 'all',
    location: 'all',
    stock: 'all'
};

// Cargar categor√≠as y marcas al iniciar
loadFilterOptions();

async function loadFilterOptions() {
    // Cargar categor√≠as
    try {
        const { data: categories } = await supabaseClient.from('categories').select('*').order('name');
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = `<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('category', 'all')">üìÇ Todas las categor√≠as</button>`;
        categories.forEach(cat => {
            categoryList.innerHTML += `<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('category', '${cat.name}')">üìÇ ${cat.name}</button>`;
        });
    } catch (error) {
        console.error('Error cargando categor√≠as:', error);
    }

    // Cargar marcas
    try {
        const { data: brands } = await supabaseClient.from('brands').select('*').order('name');
        const brandList = document.getElementById('brandList');
        brandList.innerHTML = `<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('brand', 'all')">üè∑Ô∏è Todas las marcas</button>`;
        brands.forEach(brand => {
            brandList.innerHTML += `<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('brand', '${brand.name}')">üè∑Ô∏è ${brand.name}</button>`;
        });
    } catch (error) {
        console.error('Error cargando marcas:', error);
    }
}

function getStockBadge(stock) {
    if (stock.quantity === 0) return { type: 'out', text: 'AGOTADO' };
    if (stock.quantity <= stock.min_quantity) return { type: 'min', text: 'MIN' };
    if (stock.max_quantity && stock.quantity >= stock.max_quantity) return { type: 'max', text: 'MAX' };
    return { type: 'normal', text: 'OK' };
}

function getExpiryBadge(expiryDate) {
    if (!expiryDate) return { type: 'normal', text: 'Sin fecha', color: '#6b7280', bg: '#f3f4f6' };
    const today = new Date();
    today.setHours(0,0,0,0);
    const expiry = new Date(expiryDate);
    const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { type: 'expired', text: 'CADUCADO', color: '#ffffff', bg: '#991b1b' };
    if (diffDays <= 15) return { type: 'critical', text: `${diffDays}d`, color: '#991b1b', bg: '#fee2e2' };
    if (diffDays <= 30) return { type: 'warning', text: `${diffDays}d`, color: '#92400e', bg: '#fef3c7' };
    if (diffDays <= 60) return { type: 'caution', text: `${diffDays}d`, color: '#9a3412', bg: '#ffedd5' };
    return { type: 'ok', text: `${diffDays}d`, color: '#166534', bg: '#dcfce7' };
}

function openFilterModal(type) {
    document.getElementById(type + 'Modal').classList.add('show');
}

function closeFilterModal(type) {
    document.getElementById(type + 'Modal').classList.remove('show');
}

function applyOrder(order) {
    currentSort = order;
    closeFilterModal('order');
    loadProducts();
}

function applyFilter(type, value) {
    filters[type] = value;
    closeFilterModal(type);
    
    // Actualizar indicadores
    const indicator = document.getElementById(type + 'Indicator');
    if (value !== 'all') {
        indicator.textContent = '‚óè';
        indicator.style.color = '#2563eb';
    } else {
        indicator.textContent = '‚ñº';
        indicator.style.color = '';
    }
    
    loadProducts();
}
        
        // Cargar productos al iniciar
        loadProducts();
        
async function loadProducts() {
    const container = document.getElementById('productList');
    
    try {
        container.innerHTML = '<div class="empty-state"><div style="font-size: 32px;">‚è≥</div><div>Cargando productos...</div></div>';
        
        const { data: stockData, error: stockError } = await supabaseClient
            .from('product_stock')
            .select('product_code, store_code, quantity, min_quantity, max_quantity, purchase_price, public_price, batch_number, expiry_date')
            .eq('store_code', currentStore);
        
        if (stockError) throw stockError;
        
        if (!stockData || stockData.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No hay productos en esta tienda</div>
                    <div>Comienza escaneando c√≥digos de barras</div>
                </div>`;
            return;
        }
        
        // Agrupar stock por product_code (un producto puede tener m√∫ltiples lotes)
        const stockMap = {};
        stockData.forEach(s => {
            if (!stockMap[s.product_code]) stockMap[s.product_code] = [];
            stockMap[s.product_code].push(s);
        });
        
        const productCodes = [...new Set(stockData.map(s => s.product_code))];
        const { data: products, error: productsError } = await supabaseClient
            .from('products')
            .select('*')
            .in('code', productCodes);
        
        if (productsError) throw productsError;
        
        // Crear items planos: una fila por cada lote
        inventory = [];
        products.forEach(p => {
            const lots = stockMap[p.code] || [];
            lots.forEach(lot => {
                inventory.push({
                    ...p,
                    lot_quantity: lot.quantity,
                    lot_min: lot.min_quantity,
                    lot_max: lot.max_quantity,
                    lot_purchase_price: lot.purchase_price,
                    lot_public_price: lot.public_price,
                    batch_number: lot.batch_number,
                    expiry_date: lot.expiry_date,
                    total_quantity: lots.reduce((sum, l) => sum + Number(l.quantity), 0)
                });
            });
        });
        
        let sortedInventory = [...inventory];

        // Filtros
        sortedInventory = sortedInventory.filter(item => {
            if (filters.category !== 'all' && item.category !== filters.category) return false;
            if (filters.brand !== 'all' && item.brand !== filters.brand) return false;
            if (filters.location !== 'all' && item.location !== filters.location) return false;
            
            if (filters.stock === 'out' && item.lot_quantity > 0) return false;
            if (filters.stock === 'min' && item.lot_quantity > item.lot_min) return false;
            if (filters.stock === 'max' && (!item.lot_max || item.lot_quantity < item.lot_max)) return false;
            if (filters.stock === 'expired') {
                const badge = getExpiryBadge(item.expiry_date);
                if (badge.type !== 'expired') return false;
            }
            if (filters.stock === 'critical') {
                const badge = getExpiryBadge(item.expiry_date);
                if (badge.type !== 'critical' && badge.type !== 'expired') return false;
            }
            
            return true;
        });

        // Ordenar
        switch(currentSort) {
            case 'expiry_asc':
                sortedInventory.sort((a, b) => {
                    if (!a.expiry_date && !b.expiry_date) return 0;
                    if (!a.expiry_date) return 1;
                    if (!b.expiry_date) return -1;
                    return new Date(a.expiry_date) - new Date(b.expiry_date);
                });
                break;
            case 'expiry_desc':
                sortedInventory.sort((a, b) => {
                    if (!a.expiry_date && !b.expiry_date) return 0;
                    if (!a.expiry_date) return 1;
                    if (!b.expiry_date) return -1;
                    return new Date(b.expiry_date) - new Date(a.expiry_date);
                });
                break;
            case 'created_desc':
                sortedInventory.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
            case 'created_asc':
                sortedInventory.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                break;
            case 'name_asc':
                sortedInventory.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'name_desc':
                sortedInventory.sort((a, b) => b.name.localeCompare(a.name));
                break;
            case 'code':
                sortedInventory.sort((a, b) => a.code.localeCompare(b.code));
                break;
            case 'quantity':
                sortedInventory.sort((a, b) => b.lot_quantity - a.lot_quantity);
                break;
        }
        
        container.innerHTML = sortedInventory.map((item) => {
            const expiryBadge = getExpiryBadge(item.expiry_date);
            const stockBadge = getStockBadge({ quantity: item.lot_quantity, min_quantity: item.lot_min, max_quantity: item.lot_max });
            const imageUrl = item.photo || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="60" height="60"%3E%3Crect width="60" height="60" fill="%23f3f4f6"/%3E%3Ctext x="50%25" y="50%25" font-size="24" text-anchor="middle" dy=".3em"%3Eüì¶%3C/text%3E%3C/svg%3E';
            const priceDisplay = item.lot_public_price > 0 ? `<div style="font-size: 14px; color: #16a34a; font-weight: 600;">${Number(item.lot_public_price).toFixed(2)}‚Ç¨</div>` : '';
            const expiryDisplay = item.expiry_date ? new Date(item.expiry_date).toLocaleDateString('es-ES') : 'Sin fecha';
            const batchDisplay = item.batch_number ? `Lote: ${item.batch_number}` : '';
            
            return `
                <div class="product-item" style="border-left: 4px solid ${expiryBadge.bg === '#f3f4f6' ? '#d1d5db' : expiryBadge.color};">
                    <img src="${imageUrl}" class="product-image" alt="${item.name}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'60\\' height=\\'60\\'%3E%3Crect width=\\'60\\' height=\\'60\\' fill=\\'%23f3f4f6\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' font-size=\\'24\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3Eüì¶%3C/text%3E%3C/svg%3E';" onclick="viewProduct('${item.code}')">
                    <div class="product-info" onclick="viewProduct('${item.code}')">
                        <div class="product-name">${item.name}</div>
                        <div class="product-quantity">Cant: ${item.lot_quantity} ${item.unit || 'ud'} ¬∑ ${batchDisplay}</div>
                        <div class="product-code">${item.code} ${item.internal_code ? '¬∑ Int: ' + item.internal_code : ''}</div>
                        <div style="font-size: 12px; color: ${expiryBadge.color}; font-weight: 600;">üìÖ ${expiryDisplay}</div>
                        ${priceDisplay}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                        <div style="padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; background: ${expiryBadge.bg}; color: ${expiryBadge.color};">${expiryBadge.text}</div>
                        <div class="product-badge badge-${stockBadge.type}" style="font-size: 11px;">${stockBadge.text}</div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteProduct('${item.code}', '${item.name.replace(/'/g, "\\'")}');" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 18px; margin-left: 4px;">üóëÔ∏è</button>
                </div>`;
        }).join('');
        
    } catch (error) {
        console.error('Error cargando productos:', error);
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ùå</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #ef4444;">Error al cargar productos</div>
                <div>${error.message}</div>
            </div>`;
    }
}
function getExpiryBadge(expiryDate) {
    if (!expiryDate) return { type: 'normal', text: 'Sin fecha', color: '#6b7280', bg: '#f3f4f6' };
    
    const today = new Date();
    today.setHours(0,0,0,0);
    const expiry = new Date(expiryDate);
    const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) return { type: 'expired', text: 'CADUCADO', color: '#ffffff', bg: '#991b1b' };
    if (diffDays <= 15) return { type: 'critical', text: `${diffDays}d`, color: '#991b1b', bg: '#fee2e2' };
    if (diffDays <= 30) return { type: 'warning', text: `${diffDays}d`, color: '#92400e', bg: '#fef3c7' };
    if (diffDays <= 60) return { type: 'caution', text: `${diffDays}d`, color: '#9a3412', bg: '#ffedd5' };
    return { type: 'ok', text: `${diffDays}d`, color: '#166534', bg: '#dcfce7' };
}
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const allItems = document.querySelectorAll('.product-item');
            
            allItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
              
        function viewProduct(code) {
    // Redirigir a p√°gina de escaneo con el c√≥digo
    window.location.href = 'monedas.html?code=' + code;
}
        
   async function deleteProduct(code, name) {
    if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar "${name}"?`)) {
        try {
            // 1. Obtener la URL de la foto antes de eliminar
            const { data: product, error: fetchError } = await supabaseClient
                .from('products')
                .select('photo')
                .eq('code', code)
                .single();
            
            if (fetchError) throw fetchError;
            
            // 2. Si tiene foto, eliminarla del storage
            if (product.photo && product.photo.includes('product-images')) {
                try {
                    // Extraer solo el nombre del archivo desde la URL
                    // Ejemplo: https://...supabase.co/storage/v1/object/public/product-images/products/1765316881967-7mys2gi.jpg
                    const fileName = product.photo.split('/').pop(); // Obtiene "1765316881967-7mys2gi.jpg"
                    const filePath = `products/${fileName}`; // Reconstruye "products/1765316881967-7mys2gi.jpg"
                    
                    console.log('Intentando eliminar:', filePath);
                    
                    const { error: storageError } = await supabaseClient.storage
                        .from('product-images')
                        .remove([filePath]);
                    
                    if (storageError) {
                        console.error('Error eliminando imagen:', storageError);
                    } else {
                        console.log('‚úÖ Imagen eliminada del storage');
                    }
                } catch (storageErr) {
                    console.error('Error procesando eliminaci√≥n de imagen:', storageErr);
                }
            }
            
            // 3. Eliminar el producto de la base de datos
            const { error } = await supabaseClient
                .from('products')
                .delete()
                .eq('code', code);
            
            if (error) throw error;
            
            alert('‚úÖ Producto e imagen eliminados correctamente');
            loadProducts();
            
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }
}
        function toggleDropdown() {
    document.getElementById('dropdownMenu').classList.toggle('show');
}

// Cerrar el dropdown si se hace clic fuera de √©l
window.onclick = function(event) {
    // No cerrar si se hace clic en el bot√≥n de ajustes o dentro del dropdown
    if (!event.target.matches('.settings-btn') && !event.target.closest('.dropdown-content')) {
        const dropdowns = document.getElementsByClassName('dropdown-content');
        for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
            }
        }
    }
}

function createManualProduct() {
    // Cerrar el dropdown
    document.getElementById('dropdownMenu').classList.remove('show');
    // Abrir modal para ingresar c√≥digo manual
    document.getElementById('manualProductModal').classList.add('show');
    setTimeout(() => {
        document.getElementById('manualCodeInput').focus();
    }, 100);
}
function closeManualModal() {
    document.getElementById('manualProductModal').classList.remove('show');
    document.getElementById('manualCodeInput').value = '';
}

async function confirmManualProduct() {
    const code = document.getElementById('manualCodeInput').value.trim();
    
    if (!code) {
        alert('‚ö†Ô∏è Por favor ingresa un c√≥digo o referencia');
        return;
    }
    
    if (code.length < 3) {
        alert('‚ö†Ô∏è El c√≥digo debe tener al menos 3 caracteres');
        return;
    }
    
    // Verificar si el c√≥digo ya existe
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('code')
            .eq('code', code)
            .maybeSingle();
        
        if (data) {
            if (confirm(`‚ö†Ô∏è El c√≥digo "${code}" ya existe.\n\n¬øQuieres editarlo?`)) {
    window.location.href = `monedas.html?code=${encodeURIComponent(code)}&manual=true`;
}
return;
            return;
        }
    } catch (error) {
        console.error('Error verificando c√≥digo:', error);
    }
    
    // Redirigir a monedas.html con el c√≥digo manual
window.location.href = `monedas.html?code=${encodeURIComponent(code)}&manual=true`;
}
// Permitir enviar con Enter en el modal
document.addEventListener('DOMContentLoaded', function() {
    const manualInput = document.getElementById('manualCodeInput');
    if (manualInput) {
        manualInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmManualProduct();
            }
        });
    }
});
    </script>
<!-- Modal para crear producto manual -->
<div id="manualProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">üìù Crear Producto Manual</div>
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
            Ingresa un c√≥digo de barras o referencia √∫nica para el producto
        </p>
        <input type="text" id="manualCodeInput" class="modal-input" placeholder="Ej: MAN-001, REF-ABC123..." maxlength="50">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeManualModal()">Cancelar</button>
            <button class="modal-btn modal-btn-save" onclick="confirmManualProduct()">Continuar</button>
        </div>
    </div>
</div>
<!-- Modal de Ordenar -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Ordenar por</div>
        <div style="max-height: 400px; overflow-y: auto;">
            <!-- Reemplazar el contenido del orderModal -->
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #fee2e2; color: #991b1b; font-weight: 600;" onclick="applyOrder('expiry_asc')">üî• Caducidad (pr√≥xima primero)</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('expiry_desc')">üìÖ Caducidad (lejana primero)</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('created_desc')">Fecha creaci√≥n üßì‚Üíüë∂</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('created_asc')">Fecha creaci√≥n üë∂‚Üíüßì</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('name_asc')">Alfab√©tico A‚ÜíZ</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('name_desc')">Alfab√©tico Z‚ÜíA</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('code')">Por c√≥digo</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyOrder('quantity')">Por cantidad</button> </div>
        <button class="modal-btn modal-btn-cancel" onclick="closeFilterModal('order')" style="width: 100%; margin-top: 10px;">Cerrar</button>
    </div>
</div>

<!-- Modal de Categor√≠a -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Filtrar por Categor√≠a</div>
        <div id="categoryList" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="modal-btn modal-btn-cancel" onclick="closeFilterModal('category')" style="width: 100%; margin-top: 10px;">Cerrar</button>
    </div>
</div>

<!-- Modal de Marca -->
<div id="brandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Filtrar por Marca</div>
        <div id="brandList" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="modal-btn modal-btn-cancel" onclick="closeFilterModal('brand')" style="width: 100%; margin-top: 10px;">Cerrar</button>
    </div>
</div>

<!-- Modal de Ubicaci√≥n -->
<div id="locationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Filtrar por Ubicaci√≥n</div>
        <div style="max-height: 400px; overflow-y: auto;">
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('location', 'all')">üìç Todas las ubicaciones</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('location', 'Iztieta 9103')">üìç Iztieta 9103</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('location', 'Gabierrota')">üìç Gabierrota</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('location', 'El Antiguo')">üìç El Antiguo</button>
        </div>
        <button class="modal-btn modal-btn-cancel" onclick="closeFilterModal('location')" style="width: 100%; margin-top: 10px;">Cerrar</button>
    </div>
</div>

<!-- Modal de Cantidad -->
<div id="stockModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Filtrar por Stock</div>
        <div style="max-height: 400px; overflow-y: auto;">
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #f3f4f6; color: #374151;" onclick="applyFilter('stock', 'all')">üì¶ Todas las cantidades</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #fef3c7; color: #92400e;" onclick="applyFilter('stock', 'out')">‚ùå Agotados (0)</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #fef3c7; color: #92400e;" onclick="applyFilter('stock', 'min')">‚ö†Ô∏è Cantidad m√≠nima</button>
            <button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #dcfce7; color: #166534;" onclick="applyFilter('stock', 'max')">‚úÖ Cantidad m√°xima</button>
            <!-- Agregar dentro del stockModal, despu√©s de "Cantidad m√°xima" -->
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #fee2e2; color: #991b1b;" onclick="applyFilter('stock', 'expired')">üíÄ Caducados</button>
<button class="modal-btn" style="width: 100%; margin-bottom: 10px; background: #fee2e2; color: #991b1b;" onclick="applyFilter('stock', 'critical')">üî• Pr√≥ximos a caducar (‚â§15d)</button>
        </div>
        <button class="modal-btn modal-btn-cancel" onclick="closeFilterModal('stock')" style="width: 100%; margin-top: 10px;">Cerrar</button>
    </div>
</div>
</body>
</html>